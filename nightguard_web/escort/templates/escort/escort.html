<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Escort in Progress</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        body {
            background-color: #000000;
        }
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
        }
        .directions-bar {
            background-color: #222;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .map-container {
            height: 500px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .info-bar {
            background-color: #111;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .btn-panic {
            width: 100%;
            padding: 20px;
            font-size: 1.5em;
        }
    </style>
</head>
<body>
<div class="container mt-3">

    <!-- Top Bar -->
    <div class="top-bar">
        <a href="#" class="btn btn-outline-secondary">⚙️</a>
        <a href="{% url 'logout' %}" class="btn btn-outline-danger">Logout</a>
    </div>

    <!-- Directions -->
    <div class="directions-bar text-center">
        Directions: {{ directions_text|default:"Calculating route..." }}
    </div>

    <!-- Map -->
    <div id="map" class="map-container"></div>

    <!-- Destination & ETA -->
    <div class="info-bar text-center">
        Destination: {{ destination|default:"Unknown" }} <br>
        ETA: {{ eta|default:"--:--" }}
    </div>

    <!-- Panic Button -->
    <button id="panic-btn" class="btn btn-danger btn-panic">PANIC</button>

    <div id="feedback" class="mt-2 text-center text-white"></div>

</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const feedback = document.getElementById("feedback");

    // ---------- PANIC BUTTON ----------
    document.getElementById("panic-btn").addEventListener("click", () => {
        fetch("{% url 'panic' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({})
        })
        .then(res => res.json())
        .then(data => {
            feedback.textContent = data.message || "Panic sent!";
            feedback.style.color = "red";
        })
        .catch(err => {
            feedback.textContent = "Error sending panic!";
            feedback.style.color = "orange";
            console.error(err);
        });
    });

    // ---------- MAP SETUP ----------
    const map = L.map('map').setView([0, 0], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    if (!navigator.geolocation) {
        alert("Geolocation not supported by your browser.");
        return;
    }

    let userMarker = null;
    let routeLayer = null; // Will hold the route line

    navigator.geolocation.watchPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        // Update user marker
        if (!userMarker) {
            map.setView([lat, lon], 16);
            userMarker = L.marker([lat, lon]).addTo(map)
                .bindPopup("You are here")
                .openPopup();
        } else {
            userMarker.setLatLng([lat, lon]);
        }

        // Send coordinates to backend
        fetch("{% url 'update_location' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ lat: lat, lon: lon })
        }).catch(err => console.error("Location update failed:", err));

        // ---------- DRAW ROUTE TO DESTINATION ----------
        {% if destination_coords %}
        const destLat = {{ destination_coords.0 }};
        const destLon = {{ destination_coords.1 }};

        fetch(`https://router.project-osrm.org/route/v1/driving/${lon},${lat};${destLon},${destLat}?overview=full&geometries=geojson`)
        .then(res => res.json())
        .then(data => {
            if (data.routes && data.routes.length > 0) {
                const route = data.routes[0].geometry;

                // Remove previous route if exists
                if (routeLayer) map.removeLayer(routeLayer);

                // Add new route to map
                routeLayer = L.geoJSON(route, { color: 'blue', weight: 5 }).addTo(map);
            }
        })
        .catch(err => console.error("Route fetch failed:", err));
        {% endif %}

    }, err => console.error(err), {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 5000
    });
});
</script>

</body>
</html>
